let table_heads=document.querySelectorAll(".t-head"),add_user_form=document.getElementById("form_addUser"),find_users_form=document.getElementById("form_findUsers"),url="http://localhost:3000/api/students";function countYears(e,t,r="floor"){return Math[r]((t-e)/31536e6)}class ParsePrintedData{constructor(e){this.data=e}id(){return this.data.id}faculty(){return this.data.faculty}fio(){var{surname:e,name:t,lastname:r}=this.data;return e+` ${t} `+r}birthday(){var e=this.data.birthday,t=new Date,e=new Date(e),t=countYears(e,t);return e.toLocaleDateString().replaceAll("/",".")+` (${t} лет)`}studyStart(){var e=this.data.studyStart,t=new Date,r=new Date(e,8,1),r=countYears(r,t,"ceil")<=4?countYears(r,t,"ceil")+" курс":"Закончил";return`${e}-${parseInt(e)+4} (${r})`}}class SortUsers{constructor(e){this.users=e}id(){return this.users.sort((e,t)=>parseInt(e.id)-parseInt(t.id))}fio(){return this.users.sort((e,t)=>{e=new ParsePrintedData(e).fio(),t=new ParsePrintedData(t).fio();return e.localeCompare(t)})}birthday(){return this.users.sort((e,t)=>Date.parse(e.birthday)-Date.parse(t.birthday))}studyStart(){return this.users.sort((e,t)=>parseInt(e.studyStart)-parseInt(t.studyStart))}faculty(){return this.users.sort((e,t)=>e.faculty.localeCompare(t.faculty))}}class Users{constructor(e=[]){this.data=e,this.users_list}static async sendUser(e){try{var t={method:"POST",body:JSON.stringify(e),headers:{"Content-Type":"application/json"}};return(await fetch(url,t)).status}catch(e){console.log(e)}}static async deleteUser(e){try{var t={method:"DELETE"};return(await fetch(url+"/"+e,t)).status}catch(e){console.log(e)}}async getUsers(e=""){try{var t=await(await fetch(url+"?search="+e)).json();""==e&&(this.data=t),this.printUsers(t)}catch(e){console.log(e)}}printUsers(e=this.data){if(0!=e.length){this.users_list=e,document.querySelectorAll(".user").forEach(e=>e.remove());let s=document.getElementById("temp-user_row").content,a=document.getElementById("table-body"),n=["id","fio","birthday","studyStart","faculty"];e.forEach(e=>{let t=s.cloneNode(!0),r=new ParsePrintedData(e);n.forEach(e=>{t.querySelector("."+e).textContent=r[e]()}),t.querySelector(".actions").setAttribute("id",e.id),t.querySelector(".delete_user").addEventListener("click",eventDeleteUser),a.appendChild(t)})}}sort(e){var t=new SortUsers(this.users_list);this.printUsers(t[e]())}}let users=new Users;function setMaxDateForm(){var e=new Date,t=document.querySelector('[name="birthday"]'),r=document.querySelector('[name="studyStart"]');t.max=e.toLocaleDateString().replaceAll("/","-"),r.max=e.getFullYear()}function eventForm_addUser(e){e.preventDefault();let r=e.target,s={};["name","surname","lastname","birthday","studyStart","faculty"].forEach(e=>{var t=r.querySelector(`[name="${e}"]`).value;s[e]="birthday"==e?new Date(t).toISOString():t}),Users.sendUser(s),users.getUsers()}function eventDeleteUser(e){e=e.target.parentNode.getAttribute("id");Users.deleteUser(e),users.getUsers()}function eventForm_findUsers(e){e.preventDefault();var t=e.target.param,e=e.target.param.value;t.value="",users.getUsers(e)}function eventForm_resetUsers(e){e.preventDefault(),users.printUsers()}function eventTh_sort(e,t){document.querySelectorAll("th").forEach(e=>e.classList.remove("th_selected")),e.target.classList.add("th_selected");e=t.dataset.name;users.sort(e)}table_heads.forEach(t=>{t.addEventListener("click",e=>{eventTh_sort(e,t)})}),add_user_form.addEventListener("submit",eventForm_addUser),find_users_form.addEventListener("submit",eventForm_findUsers),find_users_form.addEventListener("reset",eventForm_resetUsers),document.addEventListener("DOMContentLoaded",async e=>{setMaxDateForm(),users.getUsers()});